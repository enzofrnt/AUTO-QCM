{% extends 'base.html' %}
{% load color_filters %}

{% block content %}
  <style>
    label[for^="id_form-"][for$="-DELETE"],
    input[type="checkbox"][name$="-DELETE"] {
      display: none;
    }
    .tag-badge.selected {
      opacity: 1;
    }
    .tag-badge {
      opacity: 0.6;
    }
  </style>

  <div class="container mt-4">
    <h2>
      {% if qcm.pk %}
        Modifier le QCM
      {% else %}
        Créer un nouveau QCM
      {% endif %}
    </h2>

    <!-- Affichage des erreurs -->
    {% if form.errors or formset.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for formset_form in formset %}
            {% for field in formset_form %}
                {% for error in field.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Formulaire de filtre (déplacé en dehors du formulaire principal) -->
    {% comment %} <h3>Sélectionnez les questions :</h3>
    <form method="get" class="mb-4" id="filterForm" action="">
      <div class="form-row align-items-center">
        <div class="col-auto">
          <input type="text" name="nom" class="form-control" placeholder="Filtrer par nom" value="{{ nom_filtre }}" />
        </div>
        <div class="col-auto">
          <div class="form-group">
            <label for="tags">Filtrer par tags :</label>
            <div id="tags" class="d-flex flex-wrap">
              {% for tag in tags %}
                <span class="badge tag-badge form-check-label {% if tag.name in tag_filtre %}selected{% endif %}" data-tag-name="{{ tag.name }}" style="background-color: {{ tag.color }}; color: #fff; margin: 5px; padding: 6px 12px; border-radius: 20px; border: 2px solid {{ tag.color|darken_color:'0.3' }}; cursor: pointer;">
                  {{ tag.name }}
                </span>
              {% endfor %}
            </div>
          </div>
        </div>
        <!-- Champs cachés pour les tags sélectionnés -->
        <div id="selected-tags-container">
          {% for tag_name in tag_filtre %}
            <input type="hidden" name="tags" value="{{ tag_name }}">
          {% endfor %}
        </div>
      </div>
    </form> {% endcomment %}

    <!-- Formulaire principal -->
    <form method="post" id="qcmForm">
      {% csrf_token %}

      <!-- Champ pour le titre du QCM -->
      <div class="form-group">
        {{ form.titre.label_tag }}
        {{ form.titre }}
      </div>

      <!-- Champ pour la description du QCM -->
      <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
      </div>

      <!-- Plages associées au QCM -->
      <div class="d-flex align-items-center mb-2">
        <h3>Plages</h3>
        <button type="button" id="add-plage" class="btn btn-sm btn-outline-primary ml-2">+</button>
      </div>

      <div id="plagesFormset">
        {{ formset.management_form }}
        {% for formset_form in formset %}
          <div class="formset-row item" style="display: flex; justify-content: space-between">
            {{ formset_form.as_p }}
            <div class="form-group">
              <button type="button" class="btn btn-danger remove-plage"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Boutons pour créer ou générer des questions -->
      {% comment %} <div class="d-inline-flex mb-4">
        <a href="{% url 'question-create' %}" class="btn btn-primary ml-2">Créer une nouvelle Question</a>
        <button type="button" class="btn btn-success ml-2" id="openModal">Générer automatiquement des questions</button>
      </div> {% endcomment %}

      <!-- Liste des questions -->
      <div id="questions-list">
        
        {% comment %} <table class="table table-bordered">
          <thead>
            <tr>
              <th>Sélection</th>
              <th>Texte de la Question et Tags</th>
            </tr>
          </thead>
          <tbody>
            {% for question in questions %}
              <tr class="question-row position-relative" data-question-id="{{ question.id }}" style="cursor: pointer;">
                <td style="width: 50px;">
                  <input type="checkbox" name="selected_questions" value="{{ question.id }}" {% if question.id|stringformat:"s" in selected_question_ids %}checked{% endif %}>
                </td>
                <td>
                  {% include 'questions/question_display.html' with question=question show_buttons=False %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2">Aucune question disponible.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table> {% endcomment %}
        {% include 'questions/question_list.html' with selectable=True %}
      </div>

      <button type="submit" class="btn btn-success">
        {% if qcm.pk %}
          Modifier
        {% else %}
          Créer
        {% endif %}
      </button>
    </form>

  </div>

  <!-- Modal Popup pour l'upload du fichier et l'affichage des questions générées -->
  <!-- Votre code de modal existant -->

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Vos autres scripts -->
  <script>
    $(document).ready(function() {
      // Gestion des formulaires de plages
      // Votre code JavaScript pour gérer les plages

      // Fonction pour mettre à jour les tags sélectionnés et soumettre le formulaire
      function updateURLAndSubmit() {
        const selectedTags = $('#tags .tag-badge.selected').map(function () {
          return $(this).data('tag-name');
        }).get();

        // Mettre à jour les champs cachés pour les tags
        $('#selected-tags-container').empty();
        selectedTags.forEach(function (tagName) {
          $('#selected-tags-container').append(`<input type="hidden" name="tags" value="${tagName}">`);
        });

        // Soumettre le formulaire de filtrage
        $('#filterForm').submit();
      }

      // Gérer la sélection des tags
      $('#tags .tag-badge').click(function () {
        $(this).toggleClass('selected');
        updateURLAndSubmit();
      });

      // Fonction de debounce pour éviter les soumissions excessives
      function debounce(func, delay) {
        let debounceTimer;
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => func.apply(context, args), delay);
        }
      }

      // Appliquer le debounce à la saisie dans le champ de recherche
      $('#filterForm').find('input[name="nom"]').on('input', debounce(function () {
        $('#filterForm').submit();
      }, 500));

      // Filtrer les questions sans recharger la page
      $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        $.ajax({
          url: '',  // Laisser vide pour soumettre à la même URL
          type: 'GET',
          data: $(this).serialize(),
          success: function(data) {
            // Remplacer le contenu de la liste des questions
            var newQuestionsList = $(data).find('#questions-list').html();
            $('#questions-list').html(newQuestionsList);

            // Réappliquer les événements après la mise à jour du contenu
            reattachEvents();
          },
          error: function(xhr, status, error) {
            console.error(xhr.responseText);
          }
        });
      });

      // Fonction pour réattacher les événements après mise à jour du contenu
      function reattachEvents() {
        // Gérer le clic sur les questions pour afficher/cacher les détails
        $('.question-row').off('click').on('click', function(e) {
          if (!$(e.target).is('input[type="checkbox"]')) {
            const questionId = $(this).data('question-id');
            $('#answers-' + questionId).slideToggle(300);
          }
        });

        // Conserver les cases cochées après le filtrage
        $('input[name="selected_questions"]').each(function() {
          const questionId = $(this).val();
          if (selectedQuestionIds.includes(questionId)) {
            $(this).prop('checked', true);
          }
        });

        // Mettre à jour les tags sélectionnés
        $('#tags .tag-badge').each(function() {
          const tagName = $(this).data('tag-name');
          if (selectedTags.includes(tagName)) {
            $(this).addClass('selected');
          } else {
            $(this).removeClass('selected');
          }
        });
      }

      // Stocker les IDs des questions sélectionnées
      let selectedQuestionIds = [];
      // Mettre à jour la liste des questions sélectionnées au chargement
      updateSelectedQuestions();

      // Mettre à jour la liste des questions sélectionnées lors du changement
      $(document).on('change', 'input[name="selected_questions"]', function() {
        updateSelectedQuestions();
      });

      function updateSelectedQuestions() {
        selectedQuestionIds = $('input[name="selected_questions"]:checked').map(function() {
          return $(this).val();
        }).get();
      }

      // Appeler reattachEvents au chargement initial
      reattachEvents();
    });
  </script>
{% endblock %}
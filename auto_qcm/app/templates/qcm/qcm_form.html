{% extends 'base.html' %}
{% load color_filters %}
{% load static %}

{% block content %}
  <style>
    label[for^="id_form-"][for$="-DELETE"],
    input[type="checkbox"][name$="-DELETE"] {
      display: none;
    }
    .tag-badge.selected {
      opacity: 1;
    }
    .tag-badge {
      opacity: 0.6;
    }
  </style>

  <div class="container mt-4">
    <h2>
      {% if qcm.pk %}
        Modifier le QCM
      {% else %}
        Créer un nouveau QCM
      {% endif %}
    </h2>

    <!-- Affichage des erreurs -->
    {% if form.errors or formset.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for formset_form in formset %}
            {% for field in formset_form %}
                {% for error in field.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Formulaire de filtrage (en dehors du formulaire principal) -->
    <h3>Sélectionnez les questions :</h3>
    {% include 'questions/question_filter_form.html' %}

    <!-- Formulaire principal -->
    <form method="post" id="qcmForm">
      {% csrf_token %}

      <!-- Champ pour le titre du QCM -->
      <div class="form-group">
        {{ form.titre.label_tag }}
        {{ form.titre }}
      </div>

      <!-- Champ pour la description du QCM -->
      <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
      </div>

      <!-- Plages associées au QCM -->
      <div class="d-flex align-items-center mb-2">
        <h3>Plages</h3>
        <button type="button" id="add-plage" class="btn btn-sm btn-outline-primary ml-2">+</button>
      </div>

      <div id="plagesFormset">
        {{ formset.management_form }}
        {% for formset_form in formset %}
          <div class="formset-row item" style="display: flex; justify-content: space-between">
            {{ formset_form.as_p }}
            <div class="form-group">
              <button type="button" class="btn btn-danger remove-plage"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Liste des questions -->
      <div id="questions-list">
        {% include 'questions/question_list_content.html' with selectable=True %}
      </div>

      <button type="submit" class="btn btn-success">
        {% if qcm.pk %}
          Modifier
        {% else %}
          Créer
        {% endif %}
      </button>
    </form>

  </div> 

  <!-- Inclusion de jQuery et du script de filtrage -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'js/question_filter.js' %}"></script>

  <!-- Code JavaScript pour gérer les plages -->
  <script>
    $(document).ready(function() {
      // Gestion des formulaires de plages
      var formsetPrefix = '{{ formset.prefix }}'
      var totalForms = $('#id_' + formsetPrefix + '-TOTAL_FORMS')
      var formsetContainer = $('#plagesFormset')

      $('#add-plage').click(function() {
        var formCount = parseInt(totalForms.val())
        var newFormHtml = formsetContainer.find('.formset-row:first').clone()

        // Mise à jour des attributs 'id' et 'name' pour chaque élément cloné
        newFormHtml.find('input, select, textarea').each(function () {
          var newId = $(this)
            .attr('id')
            .replace('-0-', '-' + formCount + '-')
          var newName = $(this)
            .attr('name')
            .replace('-0-', '-' + formCount + '-')
          $(this).attr({ name: newName, id: newId })

          // Effacer les valeurs des champs
          if ($(this).attr('type') !== 'hidden') {
            $(this).val('')
          }
        })

        newFormHtml.find('.remove-plage').show()

        formsetContainer.append(newFormHtml)
        totalForms.val(formCount + 1)
      })

      // Gestion de la suppression des plages
      $(document).on('click', '.remove-plage', function() {
        // Marquer le formulaire pour suppression en cochant le champ 'DELETE'
        var formRow = $(this).closest('.formset-row')
        formRow.find('input[type="checkbox"][name$="-DELETE"]').prop('checked', true)

        // Masquer le formulaire, mais le garder dans le DOM pour l'envoyer à Django
        formRow.hide()
      })

      // Initialiser le bouton supprimer
      $('.remove-plage').each(function () {
        if ($(this).closest('.formset-row').index() === 0) {
          $(this).hide()
        }
      })
    });
  </script>
{% endblock %}
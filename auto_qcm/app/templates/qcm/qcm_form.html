{% extends 'base.html' %}
{% block content %}
  <div class="container mt-4">
    <h2>
      {% if qcm.pk %}
        Modifier le QCM
      {% else %}
        Créer un nouveau QCM
      {% endif %}
    </h2>

    <!-- Affichage des erreurs -->
    {% if form.errors or formset.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for form in formset %}
            {% for error in form.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" id="qcmForm">
      {% csrf_token %}

      <!-- Champ pour le titre du QCM -->
      <div class="form-group">
        {{ form.titre.label_tag }}
        {{ form.titre }}
      </div>

      <!-- Champ pour la description du QCM -->
      <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
      </div>

      <!-- Plages associées au QCM -->
      <div class="d-flex align-items-center mb-2">
        <h3>Plages</h3>
        <button type="button" id="addPlage" class="btn btn-sm btn-outline-primary ml-2" onclick="cloneMore()">+</button>
      </div>

      <div id="plagesFormset">
        {{ formset.management_form }}
        {% for formset_form in formset %}
          <div class="formset-row item" id="form_num0" style="display: flex; justify-content: space-between">
            <div class="form-group">{{ formset_form.debut.label_tag }} {{formset_form.debut}}</div>
            <div class="form-group">{{ formset_form.fin.label_tag }} {{formset_form.fin}}</div>
            <div class="form-group">{{ formset_form.promo.label_tag }} {{formset_form.promo}}</div>
            <div class="form-group">{{ formset_form.groupe.label_tag }} {{formset_form.groupe}}</div>

            {% with index=forloop.counter0 %}

            <div class="form-group col-md-1 mb-0 ml-2" style="position: relative;margin-top:2%">
              <button style="margin-bottom:3% ;font-weight: bold;" type="button" class="btn btn-danger"  id="del-form-{{index}}" onclick="deleteForm({{index}})"><i class="bi bi-trash"></i></button>
            </div>

            {% endwith %}
          </div>
        {% endfor %}
      </div>

      <!-- Sélection des questions -->
      <h3>Sélectionnez les questions :</h3>

      <!-- Champ pour rechercher une question -->
      <div class="d-inline-flex">
        <div class="form-group">
          <label for="searchQuestion">Rechercher une question :</label>
          <input type="text" class="form-control" id="searchQuestion" placeholder="Rechercher">
        </div>
        <!-- Bouton pour ouvrir la popup -->
        <a href="{% url 'question-create' %}" class="btn btn-primary ml-2 w-10 m-4">Créer une nouvelle Question</a>
        <button type="button" class="btn btn-success ml-2 w-10 m-4" id="openModal">Générer automatiquement des questions</button>
      </div>

      <!-- Liste des questions avec tags, case à cocher et boutons d'action -->
      <div class="form-group" id="questionsList">
        {% for question in questions %}
          <div class="form-check question-item d-flex align-items-center justify-content-between">
            <div>
              <input class="form-check-input" type="checkbox" name="selected_questions" value="{{ question.id }}" id="question_{{ question.id }}" {% if question in selected_questions %}checked{% endif %}>
              <label class="form-check-label" for="question_{{ question.id }}">
                <div>
                  <strong>{{ question.nom }} :</strong> {{ question.texte }}
                </div>
                <div>
                  {% for tag in question.tags.all %}
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              </label>
            </div>

            <!-- Boutons d'action pour modifier, supprimer, exporter -->
            <div class="btn-group" role="group">
              <a href="{% url 'question-edit' pk=question.id %}" class="btn btn-warning btn-sm">Modifier</a>
              <a href="{% url 'question-delete' question.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Voulez-vous vraiment supprimer cette question ?');">Supprimer</a>
              <a href="{% url 'question-export-xml' question.id %}" class="btn btn-info btn-sm">Exporter</a>
            </div>
          </div>
        {% endfor %}
      </div>

      <button type="submit" class="btn btn-success">
        {% if qcm.pk %}
          Modifier
        {% else %}
          Créer
        {% endif %}
      </button>
    </form>

  </div>

  <!-- Modal Popup pour l'upload du fichier et l'affichage des questions générées -->
  <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fileModalLabel">Envoyer un fichier PDF de cours pour générer des questions</h5>
        </div>
        <div class="modal-body">
          <form id="fileUploadForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="fileInput" class="form-label">Choisir un fichier PDF</label>
              <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf" required>
            </div>
          </form>
          <!-- Indicateur de chargement -->
          <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display:none;">
            <span class="visually-hidden"></span>
          </div>
          <!-- Conteneur pour les questions générées -->
          <div id="generatedQuestionsContainer" style="display: none;">
            <h4>Questions générées</h4>
            <div id="generatedQuestionsList"></div>
            <button type="button" class="btn btn-primary" id="saveSelectedQuestions">Ajouter les questions sélectionnées</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="closeModal" data-bs-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-primary" id="generateBtn">Générer</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    var hasGenerated = false;  // Indicateur pour savoir si des questions ont déjà été générées
    var questions = [];  // Variable pour stocker les questions générées

    function cloneMore() { 
      // Trouver l'élément à cloner
      var newElement = document.getElementsByClassName('item')[0].cloneNode(true);
      
      // Récupérer le nombre total de formulaires actuels
      var total = Number($("#id_form-TOTAL_FORMS").val());
      var newTotal = total + 1;
      $("#id_form-TOTAL_FORMS").val(newTotal);  // Met à jour le total des formulaires

      // Remplacer les attributs name et id des inputs
      newElement.querySelectorAll("input").forEach(function (input) {
          var name = input.getAttribute("name").replace(/\d+/, total);  // Remplacer le nombre par le nouvel index
          var id = input.getAttribute("id").replace(/\d+/, total);      // Pareil pour l'ID
          input.setAttribute("name", name);
          input.setAttribute("id", id);
          input.value = "";  // Réinitialiser la valeur des inputs
      });

      // Mettre à jour l'attribut onClick du bouton de suppression
      newElement.querySelector("button").setAttribute("onClick", `deleteForm(${total})`);
      newElement.id = `form_num${total}`;

      // Ajouter le nouvel élément cloné à la fin de la liste des items
      $("#plagesFormset").append(newElement);
    }

    function deleteForm(formNum) {
      var totalForms = Number($("#id_form-TOTAL_FORMS").val());

      if (totalForms <= 1) {
          return;  // Ne rien faire si on ne veut pas supprimer le dernier formulaire
      }

      // Décrémenter le nombre total de formulaires
      totalForms--;
      $("#id_form-TOTAL_FORMS").val(totalForms);

      // Supprimer le formulaire actuel
      $(`#form_num${formNum}`).remove();

      // Re-numéroter les formulaires restants
      var forms = $('div[id^="form_num"]');
      for (var i = 0; i < totalForms; i++) {
          var form = $(forms[i]);
          form.attr('id', `form_num${i}`);

          // Mettre à jour les inputs avec les nouveaux index
          form.find('input').each(function() {
              var name = $(this).attr('name').replace(/\d+/, i);
              var id = $(this).attr('id').replace(/\d+/, i);
              $(this).attr('name', name);
              $(this).attr('id', id);
          });

        // Mettre à jour le bouton de suppression avec le bon index
        form.find('button').attr('onClick', `deleteForm(${i})`);
    }
}


    $(document).ready(function() {
      // Ouvrir la modal lors du clic sur le bouton
      $('#openModal').click(function() {
        $('#fileModal').modal('show');
      });

      // Envoyer le fichier via Ajax lors du clic sur le bouton "Générer" ou "Régénérer"
      $('#generateBtn').click(function() {
        var formData = new FormData($('#fileUploadForm')[0]);
  
        // Afficher l'indicateur de chargement
        $('#loadingSpinner').show();
        $('#generatedQuestionsContainer').hide();
  
        $.ajax({
          url: '/question/generation/',  // URL de ta vue Django
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            $('#loadingSpinner').hide();
            $('#generatedQuestionsContainer').show();
            questions = response.questions;  // Stocker les questions générées dans la variable
            
            displayGeneratedQuestions(questions);
            
            // Changer le bouton en "Régénérer"
            hasGenerated = true;
            $('#generateBtn').text('Régénérer');
          },
          error: function(xhr, status, error) {
            $('#loadingSpinner').hide();
            console.error(xhr.responseText);  // Afficher les erreurs dans la console
          }
        });
      });
  
      // Fonction pour afficher les questions générées dans la popup
      function displayGeneratedQuestions(questions) {
        var questionsList = $('#generatedQuestionsList');
        questionsList.empty();  // Vider la liste avant d'afficher les nouvelles questions

        questions.forEach(function(question, index) {
          var questionHtml = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="${index}" id="generatedQuestion_${index}">
              <label class="form-check-label" for="generatedQuestion_${index}">
                <strong>${question.nom}</strong><br>
                ${question.texte}
                <ul>`;
          
          question.reponses.forEach(function(reponse) {
            questionHtml += `<li>${reponse.texte} ${reponse.is_correct ? '(Bonne réponse)' : ''}</li>`;
          });

          questionHtml += `</ul></label></div>`;

          questionsList.append(questionHtml);
        });
      }

      // Sauvegarder les questions sélectionnées
      $('#saveSelectedQuestions').click(function() {
        var selectedQuestions = [];

        // Récupérer les questions cochées
        $('#generatedQuestionsList input:checked').each(function() {
          var questionIndex = $(this).val();  // Utiliser l'index pour récupérer la question complète
          var questionData = questions[questionIndex];

          // Ajouter la question complète avec ses réponses dans selectedQuestions
          selectedQuestions.push({
            "nom": questionData.nom,
            "texte": questionData.texte,
            "reponses": questionData.reponses.map(function(reponse) {
              return {
                "texte": reponse.texte,
                "is_correct": reponse.is_correct
              };
            })
          });
        });

        if (selectedQuestions.length > 0) {
          // Envoyer les données sous forme de JSON
          $.ajax({
            url: '/save-questions/',  // URL pour sauvegarder les questions
            type: 'POST',
            data: JSON.stringify({
              'questions': selectedQuestions
            }),
            contentType: 'application/json',
            success: function(response) {
              alert('Questions sauvegardées avec succès !');
              window.location.reload();  // Rafraîchir la page pour voir les nouvelles questions dans la liste de QCM
            },
            error: function(xhr, status, error) {
              console.error(xhr.responseText);  // Afficher les erreurs dans la console
            }
          });
        } else {
          alert('Veuillez sélectionner au moins une question.');
        }
      });

      // Vider les variables liées à la réponse du POST lorsqu'on ferme la modal
      $('#closeModal').click(function() {
        if (!hasGenerated) {
          // Réinitialiser les champs du formulaire de génération
          $('#fileInput').val('');  // Vider le fichier sélectionné
          $('#generatedQuestionsList').empty();  // Vider la liste des questions générées
          $('#generateBtn').text('Générer');  // Réinitialiser le texte du bouton
        }
      });

      // Filtrer les questions par recherche
      $('#searchQuestion').on('input', function() {
        var searchValue = $(this).val().toLowerCase();
        $('#questionsList .question-item').each(function() {
          var questionText = $(this).text().toLowerCase();
          if (questionText.includes(searchValue)) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      });
    });

    
  </script>
{% endblock %}
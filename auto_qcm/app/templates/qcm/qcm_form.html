{% extends 'base.html' %}

{% block content %}
  <div class="container mt-4">
    <h2>Créer un Nouveau QCM</h2>

    <!-- Affichage des erreurs -->
    {% if form.errors or formset.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for form in formset %}
            {% for error in form.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" id="qcmForm">
      {% csrf_token %}

      <!-- Champ pour le titre du QCM -->
      <div class="form-group">
        {{ form.titre.label_tag }}
        {{ form.titre }}
      </div>

      <!-- Champ pour la description du QCM -->
      <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
      </div>

      <!-- Champ pour la date du QCM -->
      <div class="form-group">
        {{ form.date.label_tag }}
        {{ form.date }}
      </div>

      <!-- Recherche et filtre des questions -->
      <h3>Sélectionnez les questions :</h3>

      <!-- Champ pour rechercher une question -->
      <div class="d-inline-flex">
        <div class="form-group">
          <label for="searchQuestion">Rechercher une question :</label>
          <input type="text" class="form-control" id="searchQuestion" placeholder="Rechercher">
        </div>
        <!-- Bouton pour ouvrir la popup -->
        <button type="button" class="btn btn-success ml-2 w-10 m-4" id="openModal">Générer automatiquement des questions</button>
      </div>

      <!-- Liste des questions avec tags, case à cocher et boutons d'action -->
      <div class="form-group" id="questionsList">
        {% for question in questions %}
          <div class="form-check question-item d-flex align-items-center justify-content-between">
            <div>
              <input class="form-check-input" type="checkbox" name="selected_questions" value="{{ question.id }}" id="question_{{ question.id }}" {% if question in selected_questions %}checked{% endif %}>
              <label class="form-check-label" for="question_{{ question.id }}">
                <div>
                  <strong>{{ question.nom }} :</strong> {{ question.texte }}
                </div>
                <div>
                  {% for tag in question.tags.all %}
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              </label>
            </div>

            <!-- Boutons d'action pour modifier, supprimer, exporter -->
            <div class="btn-group" role="group">
              <a href="{% url 'question-edit' pk=question.id %}" class="btn btn-warning btn-sm">Modifier</a>
              <a href="{% url 'question-delete' question.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Voulez-vous vraiment supprimer cette question ?');">Supprimer</a>
              <a href="{% url 'question-export-xml' question.id %}" class="btn btn-info btn-sm">Exporter</a>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Bouton pour soumettre le formulaire -->
      <button type="submit" class="btn btn-success">Enregistrer</button>
    </form>
  </div>

  <!-- Modal Popup -->
  <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fileModalLabel">Uploader un fichier PDF</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="fileUploadForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="fileInput" class="form-label">Choisir un fichier PDF</label>
              <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-primary" id="uploadFileBtn">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
      // Ouvrir la modal lors du clic sur le bouton
      $('#openModal').click(function() {
        $('#fileModal').modal('show');
      });

      // Envoyer le fichier via Ajax lors du clic sur le bouton "Envoyer"
      $('#uploadFileBtn').click(function() {
        var formData = new FormData($('#fileUploadForm')[0]);

        $.ajax({
          url: '/question/generation/',  // URL de ta vue Django
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            console.log(response);  // Afficher la réponse dans la console
            $('#fileModal').modal('hide');
          },
          error: function(xhr, status, error) {
            console.error(xhr.responseText);  // Afficher les erreurs dans la console
          }
        });
      });

      // Filtrer les questions par recherche
      $('#searchQuestion').on('input', function() {
        var searchValue = $(this).val().toLowerCase();
        $('#questionsList .question-item').each(function() {
          var questionText = $(this).text().toLowerCase();
          if (questionText.includes(searchValue)) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      });
    });
  </script>
{% endblock %}